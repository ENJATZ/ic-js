set -eux
rm -fr my-svelte-project
npx degit sveltejs/template my-svelte-project
cd my-svelte-project
node scripts/setupTypeScript.js
npm install --save ..
npm install --save-dev rollup-plugin-inject

# Update the rollup config
sed -i "s?src='/build/bundle.js'?type='module' &'?g" public/index.html
sed -i "s/format: 'iife'/format: 'es'/g" rollup.config.js

# A somewhat mysterious set of tweaks
sed -i '1{s/^/import inject from "rollup-plugin-inject";\n/}' rollup.config.js
sed -i 's/resolve({/&preferBuiltins: false,/' rollup.config.js
sed -i 's/.*In dev mode/inject({Buffer: ["buffer", "Buffer"],}),\n&/g' rollup.config.js

# Add test code, to verify that the nns library works.
mv src/main.ts src/main.ts.original
{
	echo 'import { AccountIdentifier } from "@dfinity/nns";'
  cat src/main.ts.original
  cat <<-EOF
		const accountIdentifier = AccountIdentifier.fromHex(
				"a2a794c66495083317e4be5197eb655b1e63015469d769e2338af3d3e3f3aa86"
		);

		console.log("Account Identifier");
		console.log(accountIdentifier.toHex());
		EOF
} > src/main.ts

npm run build

echo ======================================================
echo STARTING SVELTE APP
echo PLEASE OPEN THE APP IN YOUR BROWSER AND VERIFY THAT IT DISPLAYS CORRECTLY AND HAS PRINTED AN ACCOUNT IDENTIFIER IN THE CONSOLE
echo ======================================================

npm start
